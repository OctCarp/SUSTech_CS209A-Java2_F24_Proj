<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.octcarp.sustech.cs209a.proj.apijava.mapper.BugAnalysisMapper">

    <resultMap id="BugAnalysisResultMap"
               type="io.github.octcarp.sustech.cs209a.proj.apijava.vo.response.basic.attached.BugStatistics">
        <result column="total_posts" property="totalPosts"/>
        <result column="question_count" property="questionCount"/>
        <result column="answer_count" property="answerCount"/>
        <result column="comment_count" property="commentCount"/>
        <result column="user_count" property="userCount"/>
        <result column="total_views" property="totalViews"/>
        <result column="total_favorites" property="totalFavorites"/>
    </resultMap>

    <!--     generated by claude-->
    <select id="getBugStatisticsById" resultMap="BugAnalysisResultMap">
        WITH bug_posts AS (
            SELECT pb.post_id, pb.post_type
            FROM Post_Bugs pb
            WHERE pb.bug_id = #{bugId}
        ),
             post_stats AS (
                 SELECT
                     COUNT(*) as total_posts,
                     COUNT(CASE WHEN post_type = 1 THEN 1 END) as question_count,
                     COUNT(CASE WHEN post_type = 2 THEN 1 END) as answer_count,
                     COUNT(CASE WHEN post_type = 4 THEN 1 END) as comment_count
                 FROM bug_posts
             ),
             view_favorite_stats AS (
                 SELECT
                     COALESCE(SUM(q.view_count), 0) as total_views,
                     COALESCE(SUM(q.favorite_count), 0) as total_favorites
                 FROM bug_posts bp
                          LEFT JOIN Questions q ON bp.post_id = q.question_id
                 WHERE bp.post_type = 1
             ),
             user_stats AS (
                 SELECT COUNT(DISTINCT u.user_id) as user_count
                 FROM bug_posts bp
                          LEFT JOIN Questions q ON bp.post_id = q.question_id AND bp.post_type = 1
                          LEFT JOIN Answers a ON bp.post_id = a.answer_id AND bp.post_type = 2
                          LEFT JOIN Comments c ON bp.post_id = c.comment_id AND bp.post_type = 4
                          LEFT JOIN Users u ON q.owner_id = u.user_id
                     OR a.owner_id = u.user_id
                     OR c.owner_id = u.user_id
             )
        SELECT
            ps.total_posts,
            ps.question_count,
            ps.answer_count,
            ps.comment_count,
            us.user_count,
            vfs.total_views,
            vfs.total_favorites
        FROM post_stats ps
                 CROSS JOIN user_stats us
                 CROSS JOIN view_favorite_stats vfs;
    </select>
<!--    <select id="getBugStatisticsById" resultMap="BugAnalysisResultMap">-->
<!--        WITH PostData AS (SELECT pb.post_id, pb.post_type-->
<!--                          FROM Post_Bugs pb-->
<!--                          WHERE pb.bug_id = #{bugId}),-->
<!--             QuestionData AS (SELECT q.*-->
<!--                              FROM Questions q-->
<!--                                       INNER JOIN PostData pd ON q.question_id = pd.post_id-->
<!--                              WHERE pd.post_type = 1),-->
<!--             AnswerData AS (SELECT a.*-->
<!--                            FROM Answers a-->
<!--                                     INNER JOIN PostData pd ON a.answer_id = pd.post_id-->
<!--                            WHERE pd.post_type = 2),-->
<!--             CommentData AS (SELECT c.*-->
<!--                             FROM Comments c-->
<!--                                      INNER JOIN PostData pd ON c.post_id = pd.post_id),-->
<!--             UserData AS (SELECT DISTINCT u.user_id-->
<!--                          FROM Users u-->
<!--                                   LEFT JOIN QuestionData qd ON u.user_id = qd.owner_id-->
<!--                                   LEFT JOIN AnswerData ad ON u.user_id = ad.owner_id-->
<!--                                   LEFT JOIN CommentData cd ON u.user_id = cd.owner_id-->
<!--                          WHERE qd.owner_id IS NOT NULL-->
<!--                             OR ad.owner_id IS NOT NULL-->
<!--                             OR cd.owner_id IS NOT NULL)-->
<!--        SELECT-->
<!--               (SELECT COUNT(*) FROM PostData)     as total_posts,-->
<!--               (SELECT COUNT(*) FROM QuestionData) as question_count,-->
<!--               (SELECT COUNT(*) FROM AnswerData)   as answer_count,-->
<!--               (SELECT COUNT(*) FROM CommentData)  as comment_count,-->
<!--               (SELECT COUNT(*) FROM UserData)     as user_count,-->
<!--               COALESCE(SUM(q.view_count), 0)      as total_views,-->
<!--               COALESCE(SUM(q.favorite_count), 0)  as total_favorites-->
<!--        FROM Bugs b-->
<!--                 LEFT JOIN QuestionData q ON 1 = 1-->
<!--        WHERE b.bug_id = #{bugId}-->
<!--        GROUP BY b.bug_id;-->
<!--    </select>-->

</mapper>